{% extends "base.html" %}

{% block content %}
<div id="followup-section" class="mt-4">
  <h5>ğŸ¤” æƒ³é€²ä¸€æ­¥äº†è§£ï¼Ÿä½ å¯ä»¥æŒçºŒè¿½å• AIï¼š</h5>

  <!-- ğŸ§  éå¾€å°è©±é¡¯ç¤ºå€ -->
  <div id="chat-box" class="mb-3 border rounded p-3" style="background:#f8f9fa;"></div>

  <!-- è¿½å•è¡¨å–® -->
  <form id="followup-form" method="post" action="{% url 'ask_ai_followup' %}">
    {% csrf_token %}
    <input type="hidden" name="question_text" value="{{ question.question_text }}">
    <input type="hidden" name="category" value="{{ category }}">
    <input type="hidden" name="options" value="{{ options }}">
    <input type="hidden" name="chat_history" id="chat_history" value="">

    <div class="mb-3">
      <textarea name="followup" class="form-control" rows="2" placeholder="è¼¸å…¥ä½ æƒ³å•çš„å•é¡Œï¼Œä¾‹å¦‚ï¼šç‚ºä»€éº¼è¦ç”¨ elifï¼Ÿ"></textarea>
    </div>
    <button type="submit" class="btn btn-primary">âœ‰ï¸ é€å‡ºè¿½å•</button>
  </form>
</div>
<script>
document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("followup-form");
  const chatBox = document.getElementById("chat-box");
  const chatHistoryInput = document.getElementById("chat_history");

  let chatHistory = "";  // å°è©±ç´€éŒ„æ–‡å­—

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const userInput = formData.get("followup");

    // é¡¯ç¤ºä½¿ç”¨è€…å•é¡Œ
    chatBox.innerHTML += `<div><strong>ğŸ‘¤ ä½ ï¼š</strong>${userInput}</div>`;

    try {
      const response = await fetch(form.action, {
        method: "POST",
        headers: { "X-CSRFToken": formData.get("csrfmiddlewaretoken") },
        body: formData,
      });

      const html = await response.text();

      // é¡¯ç¤º AI å›è¦†
      chatBox.innerHTML += `<div>${html}</div>`;

      // æ›´æ–° chat history
      chatHistory += `ğŸ‘¤ ä½ ï¼š${userInput}\nğŸ¤– AIï¼š${html.replace(/<[^>]+>/g, "")}\n`;
      chatHistoryInput.value = chatHistory;

      form.querySelector("textarea").value = "";  // æ¸…ç©ºè¼¸å…¥
    } catch (err) {
      alert("âš ï¸ ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message);
    }
  });
});
</script>
{% endblock %}
