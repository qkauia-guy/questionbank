{% extends "base.html" %}
{% load quiz_extras %}
{% block content %}
  {% for record in records %}
    <div class="card my-3">
      <div class="card-header">
        <div class="text-muted small">
          <span class="me-3">ğŸ—‚ ç§‘ç›®ï¼š{{ record.question.category }}</span>
          <span class="me-3">ğŸ“˜ ç« ç¯€ï¼š{{ record.question.chapter }} - {{ record.question.number }}</span>
        </div>
      </div>
      <div class="card-body fs-6">
        {{ record.question.question_text|safe_markdown_with_lang:record.question.category|safe }}

        <p class="mt-3 mb-2 fw-bold">æ‰€æœ‰é¸é …ï¼š</p>
        <ul class="list-group list-group-flush">
          {% for letter in "ABCDEFGH" %}
            {% with choice=record.question|get_choice:letter %}
              {% if choice and choice != "X" %}
                <li class="list-group-item small
                  {% if letter in record.question.answer|upper %}text-success{% endif %}
                  {% if letter in record.selected_answer|upper and letter not in record.question.answer|upper %}text-danger{% endif %}
                ">
                  {% if letter in record.question.answer|upper %}
                    ğŸ…¥ æ­£ç¢ºç­”æ¡ˆ 
                  {% elif letter in record.selected_answer|upper %}
                    ğŸ…§ ä½ é¸æ“‡çš„ç­”æ¡ˆ 
                  {% else %}
                    â˜‰
                  {% endif %}
                  <strong>{{ letter }}.</strong> {{ choice|safe_markdown_with_lang:record.question.category|safe }}
                </li>
              {% endif %}
            {% endwith %}
          {% endfor %}
        </ul>

        {% if record.ai_explanation or record.question.explanation %}
          <div class="mt-3">

            <!-- æ”¶è—æŒ‰éˆ• -->
            {% with b=bookmark_status|dict_get:record.question.id %}
              <button class="btn btn-sm toggle-bookmark my-2 
                {% if b.is_favorited %}btn-success{% else %}btn-outline-primary{% endif %}"
                data-question-id="{{ record.question.id }}"
                data-bookmark-type="favorite">
                {% if b.is_favorited %}â˜… å·²åŠ æ”¶è—{% else %}â˜† åŠ å…¥æ”¶è—{% endif %}
              </button>
              
              <button class="btn btn-sm toggle-bookmark mx-2
                {% if b.is_flagged %}btn-success{% else %}btn-outline-danger{% endif %}"
                data-question-id="{{ record.question.id }}"
                data-bookmark-type="flag">
                {% if b.is_flagged %}â—‰ å·²åŠ æ¨™è¨˜{% else %}â— åŠ å…¥çˆ­è­°{% endif %}
              </button>
            {% endwith %}
            {% if record.ai_explanation %}
              <button class="btn btn-outline-info btn-sm me-2 dropdown-toggle" type="button"
                      data-bs-toggle="collapse" data-bs-target="#ai-explanation-{{ forloop.counter }}">
                ãŠ• æŸ¥çœ‹ AI è£œå……èªªæ˜
              </button>
            {% endif %}

            {% if record.question.explanation %}
              <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button"
                      data-bs-toggle="collapse" data-bs-target="#manual-explanation-{{ forloop.counter }}">
                ãŠ™ æŸ¥çœ‹åŸè§£é‡‹
              </button>
            {% endif %}
            
            {% if record.ai_explanation %}
              <div class="collapse mt-2" id="ai-explanation-{{ forloop.counter }}">
                <div class="card card-body bg-light border small ai-explanation-card">
                  {{ record.ai_explanation|safe_markdown_with_lang:record.question.category|safe }}
                </div>
              </div>
            {% endif %}

            {% if record.question.explanation %}
              <div class="collapse mt-2" id="manual-explanation-{{ forloop.counter }}">
                <div class="card card-body bg-light border small manual-explanation-card">
                  {{ record.question.explanation|safe_markdown_with_lang:record.question.category|safe }}
                </div>
              </div>
            {% endif %}

              

          </div>
        {% endif %}
      </div>
    </div>
  {% empty %}
    <p class="text-muted">å¤ªæ£’äº†ï¼ç›®å‰æ²’æœ‰éŒ¯é¡Œå¯è¤‡ç¿’ã€‚</p>
  {% endfor %}

<script>
document.addEventListener("DOMContentLoaded", function () {
  console.log("âœ… JS å·²è¼‰å…¥");

  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute("content");

  document.querySelectorAll(".toggle-bookmark").forEach((btn) => {
    btn.addEventListener("click", function (e) {
      e.preventDefault();
      const questionId = this.dataset.questionId;
      const bookmarkType = this.dataset.bookmarkType;

      fetch("{% url 'toggle_bookmark' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": csrfToken,
        },
        body: new URLSearchParams({
          question_id: questionId,
          bookmark_type: bookmarkType,
        }),
      })
        .then((res) => res.json())
        .then((data) => {
          const statusDiv = document.getElementById("bookmark-status");

          const isFavorite = bookmarkType === "favorite";

          if (data.status === "added") {
            btn.classList.remove(isFavorite ? "btn-outline-primary" : "btn-outline-danger");
            btn.classList.add("btn-success");
            btn.innerText = isFavorite ? "â˜… å·²åŠ æ”¶è—" : "â—‰ å·²åŠ çˆ­è­°";
            if (statusDiv) {
              statusDiv.innerText = isFavorite ? "âœ… å·²åŠ å…¥æ”¶è—" : "âœ… å·²æ¨™è¨˜çˆ­è­°é¡Œ";
            }
          } else if (data.status === "removed") {
            btn.classList.remove("btn-success");
            btn.classList.add(isFavorite ? "btn-outline-primary" : "btn-outline-danger");
            btn.innerText = isFavorite ? "â˜† åŠ å…¥æ”¶è—" : "â— åŠ å…¥çˆ­è­°";
            if (statusDiv) {
              statusDiv.innerText = isFavorite ? "ğŸ—‘ å·²å–æ¶ˆæ”¶è—" : "ğŸ—‘ å·²å–æ¶ˆçˆ­è­°æ¨™è¨˜";
            }
          }
        })
        .catch((err) => {
          alert("âš ï¸ æ“ä½œå¤±æ•—ï¼š" + err);
        });
    });
  });
});
</script>
{% endblock %}
