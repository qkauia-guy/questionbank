{% extends "base.html" %}
{% block content %}
{% load quiz_extras %}

  <!-- ğŸ‰ è€ƒè©¦çµæœå¡ç‰‡ -->
  <div class="card border-success shadow-sm mt-3">
    <div class="card-header bg-success text-white">
      <h4 class="mb-0">ç·¨è™Ÿ ã€{{ session.id }}ã€‘æ¨¡æ“¬è€ƒçµæœ<span>(æ¸¬é©—æ™‚é–“ï¼š</strong>{{ session.created_at|date:"Y-m-d H:i" }})</span></h4>
    </div>
    <div class="card-body">
      <p class="mb-2"><strong> ç§‘ç›®ï¼š</strong>{{ session.category }}</p>
      <p class="mb-2"><strong> æ­£ç¢ºï¼š</strong>{{ correct_count }} / {{ total }} é¡Œ</p>
      <p class="mb-3"><strong> æ­£ç¢ºç‡ï¼š</strong><span class="text-success fs-5">{{ percentage }}%</span></p>

      {% if wrong_questions %}
      <!-- ğŸ§  éŒ¯é¡Œè¨˜éŒ„ï¼ˆå¯æ”¶åˆï¼‰ -->
      <div>
        <button class="btn btn-outline-danger btn-sm mt-2" type="button" data-bs-toggle="collapse" data-bs-target="#wrongList">
          éŒ¯é¡Œè¨˜éŒ„ ({{ wrong_questions|length }} é¡Œ)
          <i class="bi bi-chevron-down collapse-icon"></i>
        </button>
        <div class="collapse my-5" id="wrongList">
          <ul class="list-group">
            {% for record in wrong_questions %}
              <li class="list-group-item">
                <a class="badge bg-success fs-6 text-decoration-none my-3"
                  href="{% url 'mock_exam' %}?category={{ record.question.category|urlencode }}&chapter={{ record.question.chapter|urlencode }}&number={{ record.question.number|urlencode }}">
                  é¡Œè™Ÿ {{ record.question.chapter }} - {{ record.question.number }}
                </a>

                <!-- é¡Œç›®ä½œç‚º collapse è§¸ç™¼ -->
                <div class="mt-2 mb-2">
                  <a href="#collapse-{{ record.id }}"
                     data-bs-toggle="collapse"
                     class="text-decoration-none d-block fs-6 fw-bold">
                    {{ record.question.question_text|safe_markdown_with_lang:record.question.category|safe }}
                  </a>
                  <br>
                </div>

                <!-- â¬‡ï¸ é¸é …èˆ‡è§£é‡‹æ”¾åœ¨ collapse è£¡ -->
                <div class="collapse" id="collapse-{{ record.id }}">
                  <!-- æ‰€æœ‰é¸é … -->
                  <ul class="list-group mb-2 my-3">
                    {% for letter in "ABCDEFGH" %}
                      {% with choice=record.question|get_choice:letter %}
                        {% if choice and choice != "X" %}
                          <li class="list-group-item
                            {% if record.selected_answer and letter in record.selected_answer %} list-group-item-danger {% endif %}
                            {% if record.question.answer and letter in record.question.answer %} list-group-item-success {% endif %}
                          ">
                            <div class="d-flex justify-content-between align-items-center">
                              <div>
                                <strong>{{ letter }}.</strong>
                                {{ choice|safe_markdown_with_lang_for_options:record.question.category }}
                              </div>
                              <div class="text-end">
                                {% if record.selected_answer and letter in record.selected_answer %}
                                  <span class="badge bg-danger fs-5 text-white">éŒ¯èª¤é¸æ“‡</span>
                                {% endif %}
                                {% if record.question.answer and letter in record.question.answer %}
                                  <span class="badge bg-success fs-5">æ­£ç¢ºç­”æ¡ˆ</span>
                                {% endif %}
                              </div>
                            </div>
                          </li>
                        {% endif %}
                      {% endwith %}
                    {% endfor %}
                  </ul>

                  <!-- AI è§£é‡‹ -->
                  {% if record.ai_explanation %}
                    <div class="mt-3">
                      <strong>ğŸ’¡ AI è§£é‡‹ï¼š</strong>
                      <div class="border rounded p-2 bg-light">
                        {{ record.ai_explanation|safe_markdown_ai }}
                      </div>
                    </div>
                  {% endif %}
                </div>
              </li>
            {% endfor %}
          </ul>
        </div>
      </div>
      {% else %}
        <p class="text-muted">ğŸ‘ æœ¬æ¬¡ç„¡éŒ¯é¡Œï¼</p>
      {% endif %}
    </div>
  </div>

  <!-- ğŸ•˜ åˆ†éš”ç·š -->
  <hr class="my-4">

  <!-- ğŸ“š æ­·å²æ¨¡æ“¬è€ƒç´€éŒ„ -->
  <div class="card shadow-sm">
    <div class="card-header bg-light">
      <h5 class="mb-0 text-center">æ¨¡æ“¬è€ƒç´€éŒ„</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover table-striped align-middle text-center mb-0">
          <thead class="table-light">
            <tr>
              <th class="text-center">ç·¨è™Ÿ</th>
              <th class="text-center">é¡åˆ¥</th>
              <th class="text-center d-none d-md-table-cell">æ—¥æœŸ</th>
              <th class="text-center">åˆ†æ•¸</th>
              <th class="text-center">(éŒ¯)é¡Œæ•¸</th>
              <th class="text-center d-none d-md-table-cell">å®Œæˆæ™‚é–“</th>
              <th class="text-center">è©³æƒ…</th>
            </tr>
          </thead>
          <tbody>
            {% for s in past_sessions %}
              <tr>
                <td class="text-center"><span class="badge bg-secondary">{{ s.id }}</span></td>
                <td class="text-center">{{ s.category }}</td>
                <td class="text-center d-none d-md-table-cell">{{ s.created_at|date:"Y-m-d H:i" }}</td>
                <td class="text-center"><span class="fw-bold text-success">{{ s.score|floatformat:1 }}%</span></td>
                <td class="text-center">{{ s.wrong_count }} / {{ s.total_questions }}</td>
                <td class="text-center d-none d-md-table-cell">
                  {% if s.finished_at %}
                    {{ s.finished_at_local|date:"Y/m/d H:i" }} å…§å®Œæˆ
                  {% else %}
                    <span class="text-muted">å°šæœªå®Œæˆ</span>
                  {% endif %}
                </td>
                <td class="text-center">
                  <a href="{% url 'exam_result' s.id %}" class="btn btn-sm btn-outline-primary">
                    æŸ¥çœ‹
                  </a>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="7" class="text-muted">å°šç„¡æ¨¡æ“¬è€ƒç´€éŒ„</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>


  <!-- ğŸ” é‡æ–°é–‹å§‹æ¨¡æ“¬è€ƒ -->
  <div class="text-end mt-4">
    <a href="{% url 'exam_start' %}" class="btn btn-primary">
      é‡æ–°é–‹å§‹æ¨¡æ“¬è€ƒ
    </a>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const toggleBtn = document.querySelector('[data-bs-target="#wrongList"]');
    const icon = toggleBtn.querySelector(".collapse-icon");
    const collapse = document.getElementById("wrongList");

    collapse.addEventListener("show.bs.collapse", () => {
      icon.classList.remove("bi-chevron-down");
      icon.classList.add("bi-chevron-up");
    });

    collapse.addEventListener("hide.bs.collapse", () => {
      icon.classList.remove("bi-chevron-up");
      icon.classList.add("bi-chevron-down");
    });
  });
</script>
{% endblock %}
