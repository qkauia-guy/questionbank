{% load quiz_extras %}
{% load markdown_deux_tags %}

<div class="question-card my-3">
  <div class="d-flex gap-2 mb-3">
  <!-- Êî∂ËóèÊåâÈàï -->
    <button class="btn btn-sm toggle-bookmark 
      {% if is_favorited %}btn-success{% else %}btn-outline-primary{% endif %}"
      data-question-id="{{ question.id }}"
      data-bookmark-type="favorite">
      {% if is_favorited %}‚òÖ Â∑≤Âä†Êî∂Ëóè{% else %}‚òÜ Âä†ÂÖ•Êî∂Ëóè{% endif %}
    </button>

    <!-- Áà≠Ë≠∞È°åÊåâÈàï -->
    <button class="btn btn-sm toggle-bookmark
      {% if is_flagged %}btn-success{% else %}btn-outline-danger{% endif %}"
      data-question-id="{{ question.id }}"
      data-bookmark-type="flag">
      {% if is_flagged %}‚óâ Â∑≤Âä†Áà≠Ë≠∞{% else %}‚óé Âä†ÂÖ•Áà≠Ë≠∞{% endif %}
    </button>

</div>
  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="question_id" value="{{ question.id }}" />
    <input type="hidden" name="used_time" id="used_time" value="0" />

    <!-- È°åÁõÆËàáÈôÑÂúñ -->
    <div class="mb-3">
      {% if question.image %}
        <div class="my-3">
          <img src="{{ question.image.url }}" alt="È°åÁõÆÈôÑÂúñ"
               style="max-width: 100%; border: 1px solid #ccc; border-radius: 8px;" />
        </div>
      {% endif %}
      {{ question.question_text|safe_markdown_with_lang:question.category|safe }}
    </div>

    <!-- ÈÅ∏È†Ö -->
    {% for option in "ABCDEFGH" %}
      {% if shuffled_choices %}
        {% with choice=shuffled_choices|dict_get:option %}
          {% include "quiz/_choice_block.html" with choice=choice option=option %}
        {% endwith %}
      {% else %}
        {% with choice=question|get_choice:option %}
          {% include "quiz/_choice_block.html" with choice=choice option=option %}
        {% endwith %}
      {% endif %}
    {% endfor %}

    <!-- Â°´ÂÖÖÈ°å -->
    {% if question.is_fill_in %}
      <div class="mb-3">
        <label for="fill_answer" class="form-label">Ëº∏ÂÖ•Á≠îÊ°àÔºö</label>
        <input type="text" class="form-control" name="fill_answer" id="fill_answer" value="{{ fill_input }}" />
      </div>
    {% endif %}

    <!-- Êìç‰ΩúÊåâÈàï -->
    <div class="d-flex flex-wrap gap-2 mt-3">
      {% if show_restart %}
        <button type="submit" name="restart" class="btn btn-outline-danger">ÈáçÈ†≠ÈñãÂßã</button>
        <button type="submit" name="prev" class="btn btn-outline-secondary">‰∏ä‰∏ÄÈ°å</button>
      {% endif %}
      <button type="submit" name="skip" value="1" class="btn btn-secondary">Ë∑≥ÈÅé</button>
      <button type="submit" class="btn btn-primary">ÈÄÅÂá∫</button>
    </div>
  </form>

  {% if result is not None %}
    <div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-3" style="max-height: 90vh; overflow-y: auto">
          <div class="modal-body">
            {% if result %}
              ‚úÖ <strong>Á≠îÂ∞ç‰∫ÜÔºÅ</strong><br />
            {% else %}
              ‚ùå <strong>Á≠îÈåØ‰∫Ü„ÄÇ</strong><br />
            {% endif %}

            {% if correct_answer %}
              <div class="mt-2">üéØ Ê≠£Á¢∫Á≠îÊ°àÔºö<strong>{{ correct_answer }}</strong></div>
            {% endif %}

            {% if not result and ai_explanation %}
              <div class="mt-3">
                <strong>ü§ñ AI Ëß£ÈáãÔºö</strong><br />
                {{ ai_explanation|safe_markdown_ai|safe }}
                <hr />
                <form method="post" action="{% url 'save_ai_explanation' question.id %}?next=1" class="my-3">
                  {% csrf_token %}
                  <input type="hidden" name="explanation" value="{{ ai_explanation }}" />
                  <button type="submit" class="btn btn-sm btn-outline-success">‚òÜ Â≠òÂÖ•Ëß£Èáã</button>

                  <button class="btn btn-sm btn-outline-secondary" type="button"
                          data-bs-toggle="collapse" data-bs-target="#answerCollapse"
                          aria-expanded="false" aria-controls="answerCollapse" data-arrow-toggle>
                    ‰ΩúÁ≠îÁ¥ÄÈåÑ <span class="arrow">‚ñº</span>
                  </button>

                  {% if question.explanation %}
                    <button class="btn btn-sm btn-outline-secondary" type="button"
                            data-bs-toggle="collapse" data-bs-target="#originalExplanation"
                            aria-expanded="false" aria-controls="originalExplanation" data-arrow-toggle>
                      ÂÖàÂâçËß£Èáã <span class="arrow">‚ñº</span>
                    </button>
                  {% endif %}
                </form>

                {% if allow_followup %}
                  {% include 'quiz/_ai_followup_form.html' %}
                {% endif %}
              </div>
            {% endif %}

            {% if question.explanation %}
              <div class="collapse mt-3" id="originalExplanation">
                <div class="card card-body bg-light">
                  {{ question.explanation|safe_markdown_ai|safe }}
                </div>
              </div>
            {% endif %}

            <div class="collapse mt-4" id="answerCollapse">
              <div class="card card-body bg-light">
                {% if question.image %}
                  <img src="{{ question.image.url }}" alt="È°åÁõÆÈôÑÂúñ" class="mb-3"
                       style="max-width: 100%; border: 1px solid #ccc; border-radius: 8px;" />
                {% endif %}
                {{ question.question_text|safe_markdown_with_lang:question.category|safe }}

                <ul class="list-group mt-3">
                  {% for option in "ABCDEFGH" %}
                    {% if shuffled_choices %}
                      {% with choice=shuffled_choices|dict_get:option %}
                        {% if choice and choice != "X" %}
                          <li class="list-group-item">
                            <strong>{{ option }}.</strong>
                            {{ choice|safe_markdown_with_lang_for_options:question.category|safe }}
                            {% if option in selected_answer %}
                              <span class="badge bg-primary ms-2">‰Ω†ÁöÑÈÅ∏Êìá</span>
                            {% endif %}
                            {% if option in correct_answer_list %}
                              <span class="badge bg-success ms-1">Ê≠£Á¢∫Á≠îÊ°à</span>
                            {% endif %}
                          </li>
                        {% endif %}
                      {% endwith %}
                    {% else %}
                      {% with choice=question|get_choice:option %}
                        {% if choice and choice != "X" %}
                          <li class="list-group-item">
                            <strong>{{ option }}.</strong>
                            {{ choice|safe_markdown_with_lang_for_options:question.category|safe }}
                            {% if option in selected_answer %}
                              <span class="badge bg-primary ms-2">‰Ω†ÁöÑÈÅ∏Êìá</span>
                            {% endif %}
                            {% if option in correct_answer_list %}
                              <span class="badge bg-success ms-1">Ê≠£Á¢∫Á≠îÊ°à</span>
                            {% endif %}
                          </li>
                        {% endif %}
                      {% endwith %}
                    {% endif %}
                  {% endfor %}
                </ul>

                {% if question.is_fill_in %}
                  <div class="mt-3">
                    <strong>‰Ω†Â°´ÂØ´ÁöÑÁ≠îÊ°àÔºö</strong> {{ fill_input }}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <form method="post">
              {% csrf_token %}
              <input type="hidden" name="question_id" value="{{ question.id }}" />
              <button type="submit" name="next" value="1" class="btn btn-success">‰∏ã‰∏ÄÈ°å</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const modal = new bootstrap.Modal(document.getElementById('resultModal'))
        modal.show()

        document.querySelectorAll('.collapse').forEach((collapse) => {
          collapse.addEventListener('shown.bs.collapse', () => {
            setTimeout(() => {
              collapse.scrollIntoView({ behavior: 'smooth', block: 'start' })
            }, 100)
          })
        })

        document.querySelectorAll('[data-arrow-toggle]').forEach(function (btn) {
          const targetSelector = btn.getAttribute('data-bs-target')
          const arrowSpan = btn.querySelector('.arrow')
          const collapseEl = document.querySelector(targetSelector)

          collapseEl.addEventListener('shown.bs.collapse', () => {
            arrowSpan.textContent = '‚ñ≤'
          })

          collapseEl.addEventListener('hidden.bs.collapse', () => {
            arrowSpan.textContent = '‚ñº'
          })
        })
      })
    </script>
  {% endif %}
</div>
{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  console.log("‚úÖ JS Â∑≤ËºâÂÖ•");

  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute("content");

  document.querySelectorAll(".toggle-bookmark").forEach((btn) => {
    btn.addEventListener("click", function (e) {
      e.preventDefault();
      const questionId = this.dataset.questionId;
      const bookmarkType = this.dataset.bookmarkType;

      fetch("{% url 'toggle_bookmark' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": csrfToken,
        },
        body: new URLSearchParams({
          question_id: questionId,
          bookmark_type: bookmarkType,
        }),
      })
        .then((res) => res.json())
        .then((data) => {
          const statusDiv = document.getElementById("bookmark-status");

          const isFavorite = bookmarkType === "favorite";

          if (data.status === "added") {
            btn.classList.remove(isFavorite ? "btn-outline-primary" : "btn-outline-danger");
            btn.classList.add("btn-success");
            btn.innerText = isFavorite ? "‚òÖ Â∑≤Êî∂Ëóè" : "‚óâ Â∑≤Ê®ôË®ò";
            if (statusDiv) {
              statusDiv.innerText = isFavorite ? "‚úÖ Â∑≤Âä†ÂÖ•Êî∂Ëóè" : "‚úÖ Â∑≤Ê®ôË®òÁà≠Ë≠∞È°å";
            }
          } else if (data.status === "removed") {
            btn.classList.remove("btn-success");
            btn.classList.add(isFavorite ? "btn-outline-primary" : "btn-outline-danger");
            btn.innerText = isFavorite ? "‚òÜ Êî∂Ëóè" : "‚óé Áà≠Ë≠∞È°å";
            if (statusDiv) {
              statusDiv.innerText = isFavorite ? "üóë Â∑≤ÂèñÊ∂àÊî∂Ëóè" : "üóë Â∑≤ÂèñÊ∂àÁà≠Ë≠∞Ê®ôË®ò";
            }
          }
        })
        .catch((err) => {
          alert("‚ö†Ô∏è Êìç‰ΩúÂ§±ÊïóÔºö" + err);
        });
    });
  });
});
</script>
{% endblock %}
