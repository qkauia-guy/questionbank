{% load quiz_extras %}
{% load markdown_deux_tags %}

<!-- â¬†ï¸ å·¦ä¸Šè§’æµ®å‡ºç§’æ•¸ -->
<div id="floating-timer">
  <big>â±</big> ä½œç­”æ™‚é–“ï¼š<span id="timer">0</span> ç§’
</div>

<div class="container mt-3">
  <div class="mb-3 text-muted">
    {% if category and category != "None" %}
      <span class="me-3">ğŸ—‚ ç§‘ç›®ï¼š{{ question.category }}</span>
    {% endif %}
    <span class="me-3">ğŸ“˜ ç« ç¯€ï¼š{{ question.chapter }} - {{ question.number }}</span>
  </div>
</div>

<!-- ======================== -->
<!-- é¡Œç›®å¡ç‰‡å€å¡Š -->
<!-- ======================== -->
<div class="question-card">
  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="question_id" value="{{ question.id }}">
    <input type="hidden" name="used_time" id="used_time" value="0">

    <!-- é¡Œç›®å…§å®¹èˆ‡é™„åœ– -->
    <div class="mb-3">
      {% if question.image %}
        <div class="mt-3">
          <img src="{{ question.image.url }}" alt="é¡Œç›®é™„åœ–" style="max-width: 100%; border: 1px solid #ccc; border-radius: 8px;">
        </div>
      {% endif %}
      {% if question %}
        {{ question.question_text|safe_markdown_with_lang:question.category|safe }}
      {% endif %}
    </div>

    <!-- ======================== -->
    <!-- é¸é …å€å¡Š -->
    <!-- ======================== -->
    {% if not question.is_fill_in %}
      {% for option in "ABCDEFGH" %}
        {% with choice=shuffled_choices|dict_get:option %}
          {% if choice and choice|cut:" " != "X" %}
            <div class="form-check d-flex align-items-start gap-2 py-2 px-3 mb-3 rounded-3"
                style="background: linear-gradient(to right, #f0f4ff, #e6f0ff);">
              <input class="form-check-input mt-1"
                    type="checkbox"
                    name="selected_answer"
                    value="{{ option }}"
                    id="option_{{ option }}"
                    {% if option in selected_answer %}checked{% endif %}>

              <label class="form-check-label flex-grow-1" for="option_{{ option }}">
                <div class="d-flex align-items-start gap-2">
                  <strong>{{ option }}.</strong>
                  <!-- é¡¯ç¤ºé¸é …å…§å®¹ -->
                  <div>{{ choice|safe_markdown_with_lang_for_options:category|safe }}</div>
                </div>

                {% if not result and correct_answer and option in correct_answer %}
                  <div class="mt-2">
                    <strong> è£œå……èªªæ˜ï¼š</strong><br>
                    {{ ai_explanation|safe_markdown_with_lang:category|safe }}
                  </div>
                {% endif %}
              </label>
            </div>
          {% endif %}
        {% endwith %}
      {% endfor %}
    {% endif %}


    <!-- ======================== -->
    <!-- å¡«å……é¡Œè¼¸å…¥å€ -->
    <!-- ======================== -->
    {% if question.is_fill_in %}
      <div class="mb-3">
        <label for="fill_answer" class="form-label">è¼¸å…¥ç­”æ¡ˆï¼š</label>
        <input type="text" class="form-control" name="fill_answer" id="fill_answer" value="">
      </div>
    {% endif %}

    <!-- ======================== -->
    <!-- æ“ä½œæŒ‰éˆ• -->
    <!-- ======================== -->
    <div class="d-flex flex-wrap gap-2 mt-3">
      <button type="submit" name="skip" value="1" class="btn btn-secondary">è·³é</button>
      <button type="submit" class="btn btn-primary">é€å‡º</button>
    </div>
  </form>

  <!-- ======================== -->
  <!-- Modal çµæœé¡¯ç¤º -->
  <!-- ======================== -->
  {% if result is not None %}
    <div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-3">
          <div class="modal-body">
            {% if result %}
              âœ… <strong>ç­”å°äº†ï¼</strong><br>
            {% else %}
              âŒ <strong>ç­”éŒ¯äº†ã€‚</strong><br>
            {% endif %}

            {% if correct_answer %}
              <div class="mt-2">ğŸ¯ æ­£ç¢ºç­”æ¡ˆï¼š<strong>{{ correct_answer }}</strong></div>
            {% endif %}

            {% if not result %}
              {% if ai_explanation %}
                <div class="mt-3">
                  <strong>ğŸ¤– AI è§£é‡‹ï¼š</strong><br>
                  {{ ai_explanation|safe_markdown_ai|safe }}

                  <!-- âœ… AI å¯«å…¥æŒ‰éˆ• -->
                  <form method="post" action="{% url 'save_ai_explanation' question.id %}?next=1" class="mt-2">
                    {% csrf_token %}
                    <input type="hidden" name="explanation" value="{{ ai_explanation }}">
                    <button type="submit" class="btn btn-sm btn-outline-success">
                      âœ… å›ç­”ä¸éŒ¯ï¼Œå­˜å…¥è§£é‡‹
                    </button>
                  </form>
                </div>
              {% endif %}

              {% if question.explanation %}
                <div class="mt-4">
                  <strong>ğŸ“˜ åŸå…ˆè§£é‡‹ï¼š</strong><br>
                  {{ question.explanation|safe_markdown_ai|safe }}
                </div>
              {% endif %}
            {% endif %}
          </div>

          <div class="modal-footer">
            <form method="post">
              {% csrf_token %}
              <input type="hidden" name="question_id" value="{{ question.id }}">
              <button type="submit" name="next" value="1" class="btn btn-success">ä¸‹ä¸€é¡Œ â¡ï¸</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- é¡¯ç¤º Modal çš„ JavaScript -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        var resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
        resultModal.show();
      });
    </script>
  {% endif %}
</div>

<!-- ======================== -->
<!-- Canvas ç–ŠåŠ æ•ˆæœ -->
<!-- ======================== -->
{% include 'quiz/_overlay_canvas.html' %}
