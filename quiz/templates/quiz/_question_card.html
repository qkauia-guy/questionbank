{% load quiz_extras %}
{% load markdown_deux_tags %}

<div class="question-card my-3 mx-0">
  <div class="d-flex gap-2 mb-3">
  <!-- Êî∂ËóèÊåâÈàï -->
    <button class="btn btn-sm toggle-bookmark 
      {% if is_favorited %}btn-success{% else %}btn-outline-primary{% endif %}"
      data-question-id="{{ question.id }}"
      data-bookmark-type="favorite">
      {% if is_favorited %}‚òÖ Â∑≤Âä†Êî∂Ëóè{% else %}‚òÜ Âä†ÂÖ•Êî∂Ëóè{% endif %}
    </button>

    <!-- Áà≠Ë≠∞È°åÊåâÈàï -->
    <button class="btn btn-sm toggle-bookmark
      {% if is_flagged %}btn-success{% else %}btn-outline-danger{% endif %}"
      data-question-id="{{ question.id }}"
      data-bookmark-type="flag">
      {% if is_flagged %}‚óâ Â∑≤Âä†Áà≠Ë≠∞{% else %}‚óé Âä†ÂÖ•Áà≠Ë≠∞{% endif %}
    </button>

</div>
  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="question_id" value="{{ question.id }}" />
    <input type="hidden" name="used_time" id="used_time" value="0"/>

    <!-- È°åÁõÆËàáÈôÑÂúñ -->
    <div class="mb-3">
      {% if question.image %}
        <div class="my-3">
          <img src="{{ question.image.url }}" alt="È°åÁõÆÈôÑÂúñ"
               style="max-width: 100%; border: 1px solid #ccc; border-radius: 8px;" />
        </div>
      {% endif %}
      {{ question.question_text|safe_markdown_with_lang:question.category|safe }}
    </div>

    <!-- ÈÅ∏È†Ö -->
    {% for option in "ABCDEFGH" %}
      {% if shuffled_choices %}
        {% with choice=shuffled_choices|dict_get:option %}
          {% include "quiz/_choice_block.html" with choice=choice option=option %}
        {% endwith %}
      {% else %}
        {% with choice=question|get_choice:option %}
          {% include "quiz/_choice_block.html" with choice=choice option=option %}
        {% endwith %}
      {% endif %}
    {% endfor %}

    <!-- Â°´ÂÖÖÈ°å -->
    {% if question.is_fill_in %}
      <div class="mb-3">
        <label for="fill_answer" class="form-label">Ëº∏ÂÖ•Á≠îÊ°àÔºö</label>
        <input type="text" class="form-control" name="fill_answer" id="fill_answer" value="{{ fill_input }}" />
      </div>
    {% endif %}

    <!-- Êìç‰ΩúÊåâÈàï -->
    <div class="d-flex flex-wrap gap-2 mt-3">
      {% if show_restart %}
        <button type="submit" name="restart" class="btn btn-outline-danger">ÈáçÈ†≠ÈñãÂßã</button>
        <button type="submit" name="prev" class="btn btn-outline-secondary">‰∏ä‰∏ÄÈ°å</button>
      {% endif %}
      <button type="submit" name="skip" value="1" class="btn btn-secondary">Ë∑≥ÈÅé</button>
      <button type="submit" class="btn btn-primary">ÈÄÅÂá∫</button>
    </div>
  </form>

  {% if result is not None %}
    <div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-3" style="max-height: 90vh; overflow-y: auto">
          <div class="modal-body">

            <!-- ‚úÖ Á≠îÈ°åÁµêÊûú -->
            <div class="alert {% if result %}alert-success{% else %}alert-danger{% endif %} d-flex align-items-center gap-2" role="alert">
              <div style="font-size: 1.5rem;">
                {% if result %} üÖ• {% else %} üÖß {% endif %}
              </div>
              <div>
                <div class="fw-bold mb-1">{% if result %}Á≠îÂ∞ç‰∫ÜÔºÅ{% else %}Á≠îÈåØ‰∫Ü„ÄÇ{% endif %}</div>
                {% if correct_answer %}
                  <div class="small text-muted">üéØ Ê≠£Á¢∫Á≠îÊ°àÔºö<strong>{{ correct_answer }}</strong></div>
                {% endif %}
              </div>
            </div>


            {% if not result and ai_explanation %}
              <div class="mt-3">
                <strong>ü§ñ AI Ëß£ÈáãÔºö</strong><br />
                <div id="ai-explanation-content">{{ ai_explanation|safe_markdown_ai|safe }}</div>
                <hr />
                <form method="post" action="{% url 'save_ai_explanation' question.id %}?next=1" class="my-3">
                  {% csrf_token %}
                  <input type="hidden" name="explanation" value="{{ ai_explanation }}" />
                  <button type="submit" class="btn btn-sm btn-outline-success">‚òÜ Â≠òÂÖ•Ëß£Èáã</button>

                  <button class="btn btn-sm btn-outline-secondary" type="button"
                          data-bs-toggle="collapse" data-bs-target="#answerCollapse"
                          aria-expanded="false" aria-controls="answerCollapse" data-arrow-toggle>
                    ‰ΩúÁ≠îÁ¥ÄÈåÑ <span class="arrow">‚ñº</span>
                  </button>

                  {% if question.explanation %}
                    <button class="btn btn-sm btn-outline-secondary" type="button"
                            data-bs-toggle="collapse" data-bs-target="#originalExplanation"
                            aria-expanded="false" aria-controls="originalExplanation" data-arrow-toggle>
                      ÂÖàÂâçËß£Èáã <span class="arrow">‚ñº</span>
                    </button>
                  {% endif %}
                  <div class="markdown-content" id="explanation-{{ q.id }}">
                    {{ q.explanation }}
                  </div>
                  <button type="button"
                          class="speak-btn rounded-circle border-0 bg-white shadow-sm p-2"
                          data-target="ai-explanation-content"
                          title="ÊúóËÆÄËß£Ë™™"
                          style="width: 40px; height: 40px;">
                    <i class="bi bi-volume-up-fill text-dark fs-5"></i>
                  </button>
                </form>

                {% if allow_followup %}
                  {% include 'quiz/_ai_followup_form.html' %}
                {% endif %}
              </div>
            {% endif %}

            {% if question.explanation %}
              <div class="collapse mt-3" id="originalExplanation">
                <div class="card card-body bg-light">
                  {{ question.explanation|safe_markdown_ai|safe }}
                </div>
              </div>
            {% endif %}

            <div class="collapse mt-4" id="answerCollapse">
              <div class="card card-body bg-light">
                {% if question.image %}
                  <img src="{{ question.image.url }}" alt="È°åÁõÆÈôÑÂúñ" class="mb-3"
                       style="max-width: 100%; border: 1px solid #ccc; border-radius: 8px;" />
                {% endif %}
                {{ question.question_text|safe_markdown_with_lang:question.category|safe }}

                <ul class="list-group mt-3">
                  {% for option in "ABCDEFGH" %}
                    {% if shuffled_choices %}
                      {% with choice=shuffled_choices|dict_get:option %}
                        {% if choice and choice != "X" %}
                          <li class="list-group-item">
                            <strong>{{ option }}.</strong>
                            {{ choice|safe_markdown_with_lang_for_options:question.category|safe }}
                            {% if option in selected_answer %}
                              <span class="badge bg-primary ms-2">‰Ω†ÁöÑÈÅ∏Êìá</span>
                            {% endif %}
                            {% if option in correct_answer_list %}
                              <span class="badge bg-success ms-1">Ê≠£Á¢∫Á≠îÊ°à</span>
                            {% endif %}
                          </li>
                        {% endif %}
                      {% endwith %}
                    {% else %}
                      {% with choice=question|get_choice:option %}
                        {% if choice and choice != "X" %}
                          <li class="list-group-item">
                            <strong>{{ option }}.</strong>
                            {{ choice|safe_markdown_with_lang_for_options:question.category|safe }}
                            {% if option in selected_answer %}
                              <span class="badge bg-primary ms-2">‰Ω†ÁöÑÈÅ∏Êìá</span>
                            {% endif %}
                            {% if option in correct_answer_list %}
                              <span class="badge bg-success ms-1">Ê≠£Á¢∫Á≠îÊ°à</span>
                            {% endif %}
                          </li>
                        {% endif %}
                      {% endwith %}
                    {% endif %}
                  {% endfor %}
                </ul>

                {% if question.is_fill_in %}
                  <div class="mt-3">
                    <strong>‰Ω†Â°´ÂØ´ÁöÑÁ≠îÊ°àÔºö</strong> {{ fill_input }}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <form method="post">
              {% csrf_token %}
              <input type="hidden" name="question_id" value="{{ question.id }}" />
              <button type="submit" name="next" value="1" class="btn btn-success">‰∏ã‰∏ÄÈ°å</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const modal = new bootstrap.Modal(document.getElementById('resultModal'))
        modal.show()

        document.querySelectorAll('.collapse').forEach((collapse) => {
          collapse.addEventListener('shown.bs.collapse', () => {
            setTimeout(() => {
              collapse.scrollIntoView({ behavior: 'smooth', block: 'start' })
            }, 100)
          })
        })

        document.querySelectorAll('[data-arrow-toggle]').forEach(function (btn) {
          const targetSelector = btn.getAttribute('data-bs-target')
          const arrowSpan = btn.querySelector('.arrow')
          const collapseEl = document.querySelector(targetSelector)

          collapseEl.addEventListener('shown.bs.collapse', () => {
            arrowSpan.textContent = '‚ñ≤'
          })

          collapseEl.addEventListener('hidden.bs.collapse', () => {
            arrowSpan.textContent = '‚ñº'
          })
        })
      })
    </script>
  {% endif %}
</div>
{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  console.log("‚úÖ JS Â∑≤ËºâÂÖ•");

  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute("content");

  document.querySelectorAll(".toggle-bookmark").forEach((btn) => {
    btn.addEventListener("click", function (e) {
      e.preventDefault();
      const questionId = this.dataset.questionId;
      const bookmarkType = this.dataset.bookmarkType;

      fetch("{% url 'toggle_bookmark' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": csrfToken,
        },
        body: new URLSearchParams({
          question_id: questionId,
          bookmark_type: bookmarkType,
        }),
      })
        .then((res) => res.json())
        .then((data) => {
          const statusDiv = document.getElementById("bookmark-status");

          const isFavorite = bookmarkType === "favorite";

          if (data.status === "added") {
            btn.classList.remove(isFavorite ? "btn-outline-primary" : "btn-outline-danger");
            btn.classList.add("btn-success");
            btn.innerText = isFavorite ? "‚òÖ Â∑≤Êî∂Ëóè" : "‚óâ Â∑≤Ê®ôË®ò";
            if (statusDiv) {
              statusDiv.innerText = isFavorite ? "‚úÖ Â∑≤Âä†ÂÖ•Êî∂Ëóè" : "‚úÖ Â∑≤Ê®ôË®òÁà≠Ë≠∞È°å";
            }
          } else if (data.status === "removed") {
            btn.classList.remove("btn-success");
            btn.classList.add(isFavorite ? "btn-outline-primary" : "btn-outline-danger");
            btn.innerText = isFavorite ? "‚òÜ Êî∂Ëóè" : "‚óé Áà≠Ë≠∞È°å";
            if (statusDiv) {
              statusDiv.innerText = isFavorite ? "üóë Â∑≤ÂèñÊ∂àÊî∂Ëóè" : "üóë Â∑≤ÂèñÊ∂àÁà≠Ë≠∞Ê®ôË®ò";
            }
          }
        })
        .catch((err) => {
          alert("‚ö†Ô∏è Êìç‰ΩúÂ§±ÊïóÔºö" + err);
        });
    });
  });
});

document.addEventListener("DOMContentLoaded", function () {
  const thinks = document.querySelectorAll("think");
  thinks.forEach(el => {
    const blockquote = document.createElement("blockquote");
    blockquote.innerHTML = el.innerHTML;
    el.replaceWith(blockquote);
  });
});

document.addEventListener("DOMContentLoaded", function () {
  const speakBtn = document.querySelector(".speak-btn");
  let offsetX = 0, offsetY = 0;
  let isDragging = false;

  // === ÈõªËÖ¶ÊªëÈº†‰∫ã‰ª∂ ===
  speakBtn.addEventListener("mousedown", (e) => {
    isDragging = true;
    offsetX = e.clientX - speakBtn.offsetLeft;
    offsetY = e.clientY - speakBtn.offsetTop;
  });

  document.addEventListener("mousemove", (e) => {
    if (!isDragging) return;
    speakBtn.style.left = `${e.clientX - offsetX}px`;
    speakBtn.style.top = `${e.clientY - offsetY}px`;
  });

  document.addEventListener("mouseup", () => {
    isDragging = false;
  });

  // === ÊâãÊ©üËß∏Êéß‰∫ã‰ª∂ ===
  speakBtn.addEventListener("touchstart", (e) => {
    isDragging = true;
    const touch = e.touches[0];
    offsetX = touch.clientX - speakBtn.offsetLeft;
    offsetY = touch.clientY - speakBtn.offsetTop;
  });

  document.addEventListener("touchmove", (e) => {
    if (!isDragging) return;
    const touch = e.touches[0];
    speakBtn.style.left = `${touch.clientX - offsetX}px`;
    speakBtn.style.top = `${touch.clientY - offsetY}px`;
  });

  document.addEventListener("touchend", () => {
    isDragging = false;
  });
});

document.addEventListener("DOMContentLoaded", function () {
  const speakerBtn = document.getElementById("draggable-speaker");

  let offsetX, offsetY;
  let isDragging = false;

  function getClientXY(e) {
    if (e.type.includes("touch")) {
      return {
        x: e.touches[0].clientX,
        y: e.touches[0].clientY,
      };
    } else {
      return {
        x: e.clientX,
        y: e.clientY,
      };
    }
  }

  function startDrag(e) {
    isDragging = true;
    const { x, y } = getClientXY(e);
    const rect = speakerBtn.getBoundingClientRect();
    offsetX = x - rect.left;
    offsetY = y - rect.top;
    e.preventDefault(); // ‚úÖ Èò≤Ê≠¢ÊâãÊ©üÈ†ÅÈù¢ÊªëÂãï
  }

  function doDrag(e) {
    if (!isDragging) return;
    const { x, y } = getClientXY(e);
    speakerBtn.style.left = `${x - offsetX}px`;
    speakerBtn.style.top = `${y - offsetY}px`;
  }

  function endDrag() {
    isDragging = false;
  }

  // üëâ Ê°åÊ©üÊîØÊè¥
  speakerBtn.addEventListener("mousedown", startDrag);
  document.addEventListener("mousemove", doDrag);
  document.addEventListener("mouseup", endDrag);

  // üëâ ÊâãÊ©üÊîØÊè¥
  speakerBtn.addEventListener("touchstart", startDrag, { passive: false });
  document.addEventListener("touchmove", doDrag, { passive: false });
  document.addEventListener("touchend", endDrag);
});


document.addEventListener("DOMContentLoaded", function () {
  const buttons = document.querySelectorAll(".speak-btn");
  let voices = [];

  // ÂèñÂæóÂèØÁî®Ë™ûÈü≥
  function populateVoices() {
    voices = speechSynthesis.getVoices();
    // Âç∞Âá∫ÊâÄÊúâË™ûÈü≥ÈÅ∏È†Ö
    console.log("üì¢ ÂèØÁî®Ë™ûÈü≥Ôºö");
    voices.forEach((v, i) => {
      console.log(`[${i}] ${v.name} | ${v.lang}`);
    });
  }

  // Ë™ûÈü≥ËºâÂÖ•ÂæåËß∏Áôº
  populateVoices();
  if (speechSynthesis.onvoiceschanged !== undefined) {
    speechSynthesis.onvoiceschanged = populateVoices;
  }

  buttons.forEach((btn) => {
    btn.addEventListener("click", function () {
      const targetId = btn.getAttribute("data-target");
      const targetEl = document.getElementById(targetId);

      if (!targetEl) {
        console.warn("‚ùå Êâæ‰∏çÂà∞ÁõÆÊ®ôÂÖÉÁ¥†ÔºÅ");
        return;
      }

      const text = targetEl.innerText.trim();
      if (!text) {
        console.warn("‚ö†Ô∏è Ê≤íÊúâÂÖßÂÆπÂèØÊúóËÆÄÔºÅ");
        return;
      }

      // Ëã•Ê≠£Âú®Ë¨õË©±ÂâáÂÅúÊ≠¢
      if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
        btn.innerHTML = '<i class="bi bi-volume-up-fill text-dark fs-5"></i>';
        return;
      }

      btn.innerHTML = '<i class="bi bi-volume-mute-fill text-dark fs-5"></i>';

      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "zh-TW"; // È†êË®≠Ë™ûË®Ä
      utterance.rate = 1;

      // ÂòóË©¶ÊâæÂà∞ÊîØÊè¥‰∏≠ÊñáÁöÑË™ûÈü≥
      const preferredVoice = voices.find(v =>
        v.lang === "zh-TW" || v.lang === "zh-CN" || v.lang.startsWith("zh")
      );

      if (preferredVoice) {
        utterance.voice = preferredVoice;
        console.log("‚úÖ ‰ΩøÁî®Ë™ûÈü≥Ôºö", preferredVoice.name);
      } else {
        console.warn("‚ö†Ô∏è Êâæ‰∏çÂà∞‰∏≠ÊñáË™ûÈü≥Ôºå‰ΩøÁî®È†êË®≠");
      }

      utterance.onend = () => {
        btn.innerHTML = '<i class="bi bi-volume-up-fill text-dark fs-5"></i>';
      };

      speechSynthesis.speak(utterance);
    });
  });
});
</script>
{% endblock %}
