{% load quiz_extras %}
{% load markdown_deux_tags %}

<div class="question-card my-3 mx-0">
  <div class="d-flex gap-2 mb-3">
  <!-- æ”¶è—æŒ‰éˆ• -->
    <button class="btn btn-sm toggle-bookmark 
      {% if is_favorited %}btn-success{% else %}btn-outline-primary{% endif %}"
      data-question-id="{{ question.id }}"
      data-bookmark-type="favorite">
      {% if is_favorited %}â˜… å·²åŠ æ”¶è—{% else %}â˜† åŠ å…¥æ”¶è—{% endif %}
    </button>

    <!-- çˆ­è­°é¡ŒæŒ‰éˆ• -->
    <button class="btn btn-sm toggle-bookmark
      {% if is_flagged %}btn-success{% else %}btn-outline-danger{% endif %}"
      data-question-id="{{ question.id }}"
      data-bookmark-type="flag">
      {% if is_flagged %}â—‰ å·²åŠ çˆ­è­°{% else %}â— åŠ å…¥çˆ­è­°{% endif %}
    </button>

</div>
  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="question_id" value="{{ question.id }}" />
    <input type="hidden" name="used_time" id="used_time" value="0"/>

    <!-- é¡Œç›®èˆ‡é™„åœ– -->
    <div class="mb-3">
      {% if question.image %}
        <div class="my-3">
          <img src="{{ question.image.url }}" alt="é¡Œç›®é™„åœ–"
               style="max-width: 100%; border: 1px solid #ccc; border-radius: 8px;" />
        </div>
      {% endif %}
      {{ question.question_text|safe_markdown_with_lang:question.category|safe }}
    </div>

    <!-- é¸é … -->
    {% for option in "ABCDEFGH" %}
      {% if shuffled_choices %}
        {% with choice=shuffled_choices|dict_get:option %}
          {% include "quiz/_choice_block.html" with choice=choice option=option %}
        {% endwith %}
      {% else %}
        {% with choice=question|get_choice:option %}
          {% include "quiz/_choice_block.html" with choice=choice option=option %}
        {% endwith %}
      {% endif %}
    {% endfor %}

    <!-- å¡«å……é¡Œ -->
    {% if question.is_fill_in %}
      <div class="mb-3">
        <label for="fill_answer" class="form-label">è¼¸å…¥ç­”æ¡ˆï¼š</label>
        <input type="text" class="form-control" name="fill_answer" id="fill_answer" value="{{ fill_input }}" />
      </div>
    {% endif %}

    <!-- æ“ä½œæŒ‰éˆ• -->
    <div class="d-flex flex-wrap gap-2 mt-3">
      {% if show_restart %}
        <button type="submit" name="restart" class="btn btn-outline-danger">é‡é ­é–‹å§‹</button>
        <button type="submit" name="prev" class="btn btn-outline-secondary">ä¸Šä¸€é¡Œ</button>
      {% endif %}
      <button type="submit" name="skip" value="1" class="btn btn-secondary">è·³é</button>
      <button type="submit" class="btn btn-primary">é€å‡º</button>
    </div>
  </form>

  {% if result is not None %}
    <div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-3" style="max-height: 90vh; overflow-y: auto">
          <div class="modal-body">

            <!-- âœ… ç­”é¡Œçµæœ -->
            <div class="alert {% if result %}alert-success{% else %}alert-danger{% endif %} d-flex align-items-center gap-2" role="alert">
              <div style="font-size: 1.5rem;">
                {% if result %} ğŸ…¥ {% else %} ğŸ…§ {% endif %}
              </div>
              <div>
                <div class="fw-bold mb-1">{% if result %}ç­”å°äº†ï¼{% else %}ç­”éŒ¯äº†ã€‚{% endif %}</div>
                {% if correct_answer %}
                  <div class="small text-muted">ğŸ¯ æ­£ç¢ºç­”æ¡ˆï¼š<strong>{{ correct_answer }}</strong></div>
                {% endif %}
              </div>
            </div>


            {% if not result and ai_explanation %}
              <div class="mt-3">
                <strong>ğŸ¤– AI è§£é‡‹ï¼š</strong><br />
                <div id="ai-explanation-content">{{ ai_explanation|safe_markdown_ai|safe }}</div>
                <hr />
                <form method="post" action="{% url 'save_ai_explanation' question.id %}?next=1" class="my-3">
                  {% csrf_token %}
                  <input type="hidden" name="explanation" value="{{ ai_explanation }}" />
                  <button type="submit" class="btn btn-sm btn-outline-success">â˜† å­˜å…¥è§£é‡‹</button>

                  <button class="btn btn-sm btn-outline-secondary" type="button"
                          data-bs-toggle="collapse" data-bs-target="#answerCollapse"
                          aria-expanded="false" aria-controls="answerCollapse" data-arrow-toggle>
                    ä½œç­”ç´€éŒ„ <span class="arrow">â–¼</span>
                  </button>

                  {% if question.explanation %}
                    <button class="btn btn-sm btn-outline-secondary" type="button"
                            data-bs-toggle="collapse" data-bs-target="#originalExplanation"
                            aria-expanded="false" aria-controls="originalExplanation" data-arrow-toggle>
                      å…ˆå‰è§£é‡‹ <span class="arrow">â–¼</span>
                    </button>
                  {% endif %}
                  <div class="markdown-content" id="explanation-{{ q.id }}">
                    {{ q.explanation }}
                  </div>
                  <button type="button"
                          class="speak-btn rounded-circle border-0 bg-white shadow-sm p-2"
                          data-target="ai-explanation-content"
                          title="æœ—è®€è§£èªª"
                          style="width: 40px; height: 40px;">
                    <i class="bi bi-volume-up-fill text-dark fs-5"></i>
                  </button>
                </form>

                {% if allow_followup %}
                  {% include 'quiz/_ai_followup_form.html' %}
                {% endif %}
              </div>
            {% endif %}

            {% if question.explanation %}
              <div class="collapse mt-3" id="originalExplanation">
                <div class="card card-body bg-light">
                  {{ question.explanation|safe_markdown_ai|safe }}
                </div>
              </div>
            {% endif %}

            <div class="collapse mt-4" id="answerCollapse">
              <div class="card card-body bg-light">
                {% if question.image %}
                  <img src="{{ question.image.url }}" alt="é¡Œç›®é™„åœ–" class="mb-3"
                       style="max-width: 100%; border: 1px solid #ccc; border-radius: 8px;" />
                {% endif %}
                {{ question.question_text|safe_markdown_with_lang:question.category|safe }}

                <ul class="list-group mt-3">
                  {% for option in "ABCDEFGH" %}
                    {% if shuffled_choices %}
                      {% with choice=shuffled_choices|dict_get:option %}
                        {% if choice and choice != "X" %}
                          <li class="list-group-item">
                            <strong>{{ option }}.</strong>
                            {{ choice|safe_markdown_with_lang_for_options:question.category|safe }}
                            {% if option in selected_answer %}
                              <span class="badge bg-primary ms-2">ä½ çš„é¸æ“‡</span>
                            {% endif %}
                            {% if option in correct_answer_list %}
                              <span class="badge bg-success ms-1">æ­£ç¢ºç­”æ¡ˆ</span>
                            {% endif %}
                          </li>
                        {% endif %}
                      {% endwith %}
                    {% else %}
                      {% with choice=question|get_choice:option %}
                        {% if choice and choice != "X" %}
                          <li class="list-group-item">
                            <strong>{{ option }}.</strong>
                            {{ choice|safe_markdown_with_lang_for_options:question.category|safe }}
                            {% if option in selected_answer %}
                              <span class="badge bg-primary ms-2">ä½ çš„é¸æ“‡</span>
                            {% endif %}
                            {% if option in correct_answer_list %}
                              <span class="badge bg-success ms-1">æ­£ç¢ºç­”æ¡ˆ</span>
                            {% endif %}
                          </li>
                        {% endif %}
                      {% endwith %}
                    {% endif %}
                  {% endfor %}
                </ul>

                {% if question.is_fill_in %}
                  <div class="mt-3">
                    <strong>ä½ å¡«å¯«çš„ç­”æ¡ˆï¼š</strong> {{ fill_input }}
                  </div>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <form method="post">
              {% csrf_token %}
              <input type="hidden" name="question_id" value="{{ question.id }}" />
              <button type="submit" name="next" value="1" class="btn btn-success">ä¸‹ä¸€é¡Œ</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const modal = new bootstrap.Modal(document.getElementById('resultModal'))
        modal.show()

        document.querySelectorAll('.collapse').forEach((collapse) => {
          collapse.addEventListener('shown.bs.collapse', () => {
            setTimeout(() => {
              collapse.scrollIntoView({ behavior: 'smooth', block: 'start' })
            }, 100)
          })
        })

        document.querySelectorAll('[data-arrow-toggle]').forEach(function (btn) {
          const targetSelector = btn.getAttribute('data-bs-target')
          const arrowSpan = btn.querySelector('.arrow')
          const collapseEl = document.querySelector(targetSelector)

          collapseEl.addEventListener('shown.bs.collapse', () => {
            arrowSpan.textContent = 'â–²'
          })

          collapseEl.addEventListener('hidden.bs.collapse', () => {
            arrowSpan.textContent = 'â–¼'
          })
        })
      })
    </script>
  {% endif %}
</div>
{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  console.log("âœ… JS å·²è¼‰å…¥");

  const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute("content");

  document.querySelectorAll(".toggle-bookmark").forEach((btn) => {
    btn.addEventListener("click", function (e) {
      e.preventDefault();
      const questionId = this.dataset.questionId;
      const bookmarkType = this.dataset.bookmarkType;

      fetch("{% url 'toggle_bookmark' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": csrfToken,
        },
        body: new URLSearchParams({
          question_id: questionId,
          bookmark_type: bookmarkType,
        }),
      })
        .then((res) => res.json())
        .then((data) => {
          const statusDiv = document.getElementById("bookmark-status");

          const isFavorite = bookmarkType === "favorite";

          if (data.status === "added") {
            btn.classList.remove(isFavorite ? "btn-outline-primary" : "btn-outline-danger");
            btn.classList.add("btn-success");
            btn.innerText = isFavorite ? "â˜… å·²æ”¶è—" : "â—‰ å·²æ¨™è¨˜";
            if (statusDiv) {
              statusDiv.innerText = isFavorite ? "âœ… å·²åŠ å…¥æ”¶è—" : "âœ… å·²æ¨™è¨˜çˆ­è­°é¡Œ";
            }
          } else if (data.status === "removed") {
            btn.classList.remove("btn-success");
            btn.classList.add(isFavorite ? "btn-outline-primary" : "btn-outline-danger");
            btn.innerText = isFavorite ? "â˜† æ”¶è—" : "â— çˆ­è­°é¡Œ";
            if (statusDiv) {
              statusDiv.innerText = isFavorite ? "ğŸ—‘ å·²å–æ¶ˆæ”¶è—" : "ğŸ—‘ å·²å–æ¶ˆçˆ­è­°æ¨™è¨˜";
            }
          }
        })
        .catch((err) => {
          alert("âš ï¸ æ“ä½œå¤±æ•—ï¼š" + err);
        });
    });
  });
});

document.addEventListener("DOMContentLoaded", function () {
  const thinks = document.querySelectorAll("think");
  thinks.forEach(el => {
    const blockquote = document.createElement("blockquote");
    blockquote.innerHTML = el.innerHTML;
    el.replaceWith(blockquote);
  });
});

document.addEventListener("DOMContentLoaded", function () {
  const speakBtn = document.querySelector(".speak-btn");
  let offsetX = 0, offsetY = 0;
  let isDragging = false;

  // === é›»è…¦æ»‘é¼ äº‹ä»¶ ===
  speakBtn.addEventListener("mousedown", (e) => {
    isDragging = true;
    offsetX = e.clientX - speakBtn.offsetLeft;
    offsetY = e.clientY - speakBtn.offsetTop;
  });

  document.addEventListener("mousemove", (e) => {
    if (!isDragging) return;
    speakBtn.style.left = `${e.clientX - offsetX}px`;
    speakBtn.style.top = `${e.clientY - offsetY}px`;
  });

  document.addEventListener("mouseup", () => {
    isDragging = false;
  });

  // === æ‰‹æ©Ÿè§¸æ§äº‹ä»¶ ===
  speakBtn.addEventListener("touchstart", (e) => {
    isDragging = true;
    const touch = e.touches[0];
    offsetX = touch.clientX - speakBtn.offsetLeft;
    offsetY = touch.clientY - speakBtn.offsetTop;
  });

  document.addEventListener("touchmove", (e) => {
    if (!isDragging) return;
    const touch = e.touches[0];
    speakBtn.style.left = `${touch.clientX - offsetX}px`;
    speakBtn.style.top = `${touch.clientY - offsetY}px`;
  });

  document.addEventListener("touchend", () => {
    isDragging = false;
  });
});

document.addEventListener("DOMContentLoaded", function () {
  const speakerBtn = document.getElementById("draggable-speaker");

  let offsetX, offsetY;
  let isDragging = false;

  function getClientXY(e) {
    if (e.type.includes("touch")) {
      return {
        x: e.touches[0].clientX,
        y: e.touches[0].clientY,
      };
    } else {
      return {
        x: e.clientX,
        y: e.clientY,
      };
    }
  }

  function startDrag(e) {
    isDragging = true;
    const { x, y } = getClientXY(e);
    const rect = speakerBtn.getBoundingClientRect();
    offsetX = x - rect.left;
    offsetY = y - rect.top;
    e.preventDefault(); // âœ… é˜²æ­¢æ‰‹æ©Ÿé é¢æ»‘å‹•
  }

  function doDrag(e) {
    if (!isDragging) return;
    const { x, y } = getClientXY(e);
    speakerBtn.style.left = `${x - offsetX}px`;
    speakerBtn.style.top = `${y - offsetY}px`;
  }

  function endDrag() {
    isDragging = false;
  }

  // ğŸ‘‰ æ¡Œæ©Ÿæ”¯æ´
  speakerBtn.addEventListener("mousedown", startDrag);
  document.addEventListener("mousemove", doDrag);
  document.addEventListener("mouseup", endDrag);

  // ğŸ‘‰ æ‰‹æ©Ÿæ”¯æ´
  speakerBtn.addEventListener("touchstart", startDrag, { passive: false });
  document.addEventListener("touchmove", doDrag, { passive: false });
  document.addEventListener("touchend", endDrag);
});


document.addEventListener("DOMContentLoaded", function () {
  const buttons = document.querySelectorAll(".speak-btn");
  let voices = [];

  // å–å¾—å¯ç”¨èªéŸ³
  function populateVoices() {
    voices = speechSynthesis.getVoices();
    // å°å‡ºæ‰€æœ‰èªéŸ³é¸é …
    console.log("ğŸ“¢ å¯ç”¨èªéŸ³ï¼š");
    voices.forEach((v, i) => {
      console.log(`[${i}] ${v.name} | ${v.lang}`);
    });
  }

  // èªéŸ³è¼‰å…¥å¾Œè§¸ç™¼
  populateVoices();
  if (speechSynthesis.onvoiceschanged !== undefined) {
    speechSynthesis.onvoiceschanged = populateVoices;
  }

  buttons.forEach((btn) => {
    btn.addEventListener("click", function () {
      const targetId = btn.getAttribute("data-target");
      const targetEl = document.getElementById(targetId);

      if (!targetEl) {
        console.warn("âŒ æ‰¾ä¸åˆ°ç›®æ¨™å…ƒç´ ï¼");
        return;
      }

      const text = targetEl.innerText.trim();
      if (!text) {
        console.warn("âš ï¸ æ²’æœ‰å…§å®¹å¯æœ—è®€ï¼");
        return;
      }

      // è‹¥æ­£åœ¨è¬›è©±å‰‡åœæ­¢
      if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
        btn.innerHTML = '<i class="bi bi-volume-up-fill text-dark fs-5"></i>';
        return;
      }

      btn.innerHTML = '<i class="bi bi-volume-mute-fill text-dark fs-5"></i>';

      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "zh-TW"; // é è¨­èªè¨€
      utterance.rate = 1;

      // å˜—è©¦æ‰¾åˆ°æ”¯æ´ä¸­æ–‡çš„èªéŸ³
      const preferredVoice = voices.find(v =>
        v.lang === "zh-TW" || v.lang === "zh-CN" || v.lang.startsWith("zh")
      );

      if (preferredVoice) {
        utterance.voice = preferredVoice;
        console.log("âœ… ä½¿ç”¨èªéŸ³ï¼š", preferredVoice.name);
      } else {
        console.warn("âš ï¸ æ‰¾ä¸åˆ°ä¸­æ–‡èªéŸ³ï¼Œä½¿ç”¨é è¨­");
      }

      utterance.onend = () => {
        btn.innerHTML = '<i class="bi bi-volume-up-fill text-dark fs-5"></i>';
      };

      speechSynthesis.speak(utterance);
    });
  });
});
</script>
{% endblock %}
