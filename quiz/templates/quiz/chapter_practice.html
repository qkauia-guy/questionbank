{% extends "base.html" %}
{% load quiz_extras %}
{% load markdown_deux_tags %}
{% block content %}
<!-- â¬†ï¸ å·¦ä¸Šè§’æµ®å‡ºç§’æ•¸ -->
<div id="floating-timer">
  ä½œç­”æ™‚é–“ï¼š<span id="timer">0</span> ç§’
</div>

<div class="container">
  <div class="mb-3 text-muted">
    <span class="me-3">ğŸ—‚ é¡åˆ¥ï¼š{{ question.category }}</span>
    <span class="me-3">ğŸ“˜ ç« ç¯€ï¼š{{ question.chapter }} - {{ question.number }}</span>
    <span>ğŸ“š é¡Œåº«ç¸½æ•¸ï¼š{{ total_question_count }} é¡Œ</span>
  </div>

  <div class="question-card">
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="question_id" value="{{ question.id }}">
      <input type="hidden" name="used_time" id="used_time" value="0">

      <div class="mb-3">
        {{ question.question_text|safe_markdown_no_h1|safe }}
      </div>

      <!-- âœ… å–®é¸æˆ–å¤šé¸ -->
      {% for option in "ABCDEFGH" %}
        {% with choice=question|get_choice:option %}
          {% if choice and choice|cut:" " != "X" %}
            <div class="form-check d-flex align-items-center gap-2 py-2 px-3 mb-3 rounded-3" style="background: linear-gradient(to right, #f0f4ff, #e6f0ff);">
              <input class="form-check-input mt-1"
                     type="checkbox"
                     name="selected_answer"
                     value="{{ option }}"
                     id="option_{{ option }}"
                     {% if result is none and option in selected_answer %}checked{% endif %}>
              <label class="form-check-label flex-grow-1" for="option_{{ option }}">
                <strong>{{ option }}.</strong> {{ choice|markdown|safe }}
              </label>
            </div>
          {% endif %}
        {% endwith %}
      {% endfor %}

      {% if question.is_fill_in %}
        <div class="mb-3">
          <label for="fill_answer" class="form-label">è«‹è¼¸å…¥ç¨‹å¼ç¢¼ï¼š</label>
          <input type="text" class="form-control" name="fill_answer" id="fill_answer" value="{{ fill_input }}">
        </div>
      {% endif %}

      <div class="d-flex flex-wrap gap-2 mt-3">
        <button type="submit" name="restart" class="btn btn-outline-danger">é‡é ­é–‹å§‹</button>
        <button type="submit" name="prev" class="btn btn-outline-secondary">ä¸Šä¸€é¡Œ</button>
        <button type="submit" name="skip" value="1" class="btn btn-secondary">è·³é</button>
        <button type="submit" class="btn btn-primary">é€å‡º</button>
      </div>
    </form>
    <!-- âœ… æŠŠé€™æ®µæ”¾åœ¨ form å¤–ï¼ä¸æ˜¯ form è£¡ï¼ -->
    {% if result is not None %}
      <div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content p-3">
            <div class="modal-body">
              {% if result %}
                âœ… <strong>ç­”å°äº†ï¼</strong><br>
              {% else %}
                âŒ <strong>ç­”éŒ¯äº†ã€‚</strong><br>
              {% endif %}

              {% if correct_answer %}
                <div class="mt-2">ğŸ¯ æ­£ç¢ºç­”æ¡ˆï¼š<strong>{{ correct_answer }}</strong></div>
              {% endif %}

              {% if not result and ai_explanation %}
                <div class="mt-3">
                  ğŸ¤– <strong>AI è£œå……èªªæ˜ï¼š</strong><br>
                  {{ ai_explanation|safe_markdown_no_h1|safe }}
                </div>
              {% endif %}
            </div>
            <div class="modal-footer">
              <!-- æ³¨æ„ï¼šé‚„æ˜¯åœ¨ form è£¡è§¸ç™¼ submit -->
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="question_id" value="{{ question.id }}">
                <button type="submit" name="next" value="1" class="btn btn-success">ä¸‹ä¸€é¡Œ â¡ï¸</button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- é¡¯ç¤º Modal -->
      <script>
        document.addEventListener("DOMContentLoaded", function () {
          var resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
          resultModal.show();
        });
      </script>
      {% endif %}
  </div>
</div>

{% include 'quiz/_overlay_canvas.html' %}
{% include 'quiz/_search_chapter_practice.html' %}
{% endblock %}
