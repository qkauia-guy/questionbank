{% extends "base.html" %}
{% load quiz_extras %}
{% load markdown_deux_tags %}
{% block content %}
{% load static %}
{% block extra_scripts %}
  <script src="{% static 'js/canvas-pen.js' %}" defer></script>
{% endblock %}

<!-- â¬†ï¸ å·¦ä¸Šè§’æµ®å‡ºç§’æ•¸ -->
<div id="floating-timer">
  ä½œç­”æ™‚é–“ï¼š<span id="timer">0</span> ç§’
</div>

<input type="hidden" name="used_time" id="used_time" value="0">

<div class="container">
  <div class="mb-3 text-muted mt-3">
    {% if category and category != "None" %}
      <span class="me-3">ğŸ—‚ ç§‘ç›®ï¼š{{ question.category }}</span>
    {% endif %}
    <span class="me-3">ğŸ“˜ ç« ç¯€ï¼š{{ question.chapter }} - {{ question.number }}</span>
  </div>

  {% if category_total %}
    <div class="progress mb-3 position-relative" style="height: 20px; background-color: #444;">
      <div class="progress-bar"
          role="progressbar"
          data-width="{{ current_index|add:1|div:category_total|mul:100|floatformat:0 }}"
          style="width: 0%; background-color: rgba(255, 255, 255, 0.25);">
      </div>
      <div class="progress-label">
        ç¬¬ {{ current_index|add:1 }} é¡Œ / å…± {{ category_total }} é¡Œ
      </div>
    </div>
  {% endif %}
</div>

{% if not category or category == "None" %}
  <div class="alert alert-warning mt-3" role="alert">
    âš ï¸ è«‹å…ˆé¸æ“‡ç§‘ç›®å¾Œå†é–‹å§‹ç·´ç¿’ã€‚
  </div>
{% else %}
  <div class="question-card">
    <form method="post">
      {% csrf_token %}
      <input type="hidden" name="question_id" value="{{ question.id }}">
      <input type="hidden" name="used_time" id="used_time" value="0">

      <!-- é¡Œç›® -->
      <div class="mb-3">
        {% if question.image %}
          <div class="mt-3">
            <img src="{{ question.image.url }}" alt="é¡Œç›®é™„åœ–" style="max-width: 100%; border: 1px solid #ccc; border-radius: 8px;">
          </div>
        {% endif %}
        {{ question.question_text|safe_markdown_with_lang:question.category|safe }}
      </div>

      <!-- é¸é … -->
      {% for option in "ABCDEFGH" %}
        {% with choice=question|get_choice:option category=question.category %}
          {% if choice and choice|cut:" " != "X" %}
            <div class="form-check d-flex align-items-center gap-2 py-2 px-3 mb-3 rounded-3"
                 style="background: linear-gradient(to right, #f0f4ff, #e6f0ff);">
              <input class="form-check-input mt-1"
                     type="checkbox"
                     name="selected_answer"
                     value="{{ option }}"
                     id="option_{{ option }}"
                     {% if result is none and option in selected_answer %}checked{% endif %}>
              <label class="form-check-label flex-grow-1" for="option_{{ option }}">
                <strong>{{ option }}.</strong>
                <div>{{ choice|safe_markdown_with_lang_for_options:category|safe }}</div>
              </label>
            </div>
          {% endif %}
        {% endwith %}
      {% endfor %}

      <!-- å¡«å……é¡Œ -->
      {% if question.is_fill_in %}
        <div class="mb-3">
          <label for="fill_answer" class="form-label">è¼¸å…¥ç­”æ¡ˆï¼š</label>
          <input type="text" class="form-control" name="fill_answer" id="fill_answer" value="{{ fill_input }}">
        </div>
      {% endif %}

      <!-- æŒ‰éˆ• -->
      <div class="d-flex flex-wrap gap-2 mt-3">
        <button type="submit" name="restart" class="btn btn-outline-danger">é‡é ­é–‹å§‹</button>
        <button type="submit" name="prev" class="btn btn-outline-secondary">ä¸Šä¸€é¡Œ</button>
        <button type="submit" name="skip" value="1" class="btn btn-secondary">ä¸‹ä¸€é¡Œ</button>
        <button type="submit" class="btn btn-primary">é€å‡º</button>
      </div>
    </form>

    <!-- ç­”æ¡ˆ Modal -->
    {% if result is not None %}
      <div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content p-3">
            <div class="modal-body">
              {% if result %}
                âœ… <strong>ç­”å°äº†ï¼</strong><br>
              {% else %}
                âŒ <strong>ç­”éŒ¯äº†ã€‚</strong><br>
              {% endif %}

              {% if correct_answer %}
                <div class="mt-2">ğŸ¯ æ­£ç¢ºç­”æ¡ˆï¼š<strong>{{ correct_answer }}</strong></div>
              {% endif %}

              {% if not result %}
                {% if ai_explanation %}
                  <div class="mt-3">
                    <strong>ğŸ¤– AI è§£é‡‹ï¼š</strong><br>
                    {{ ai_explanation|safe_markdown_ai|safe }}

                    <!-- âœ… AI å¯«å…¥æŒ‰éˆ• -->
                    <form method="post" action="{% url 'save_ai_explanation' question.id %}?next=1" class="mt-2">
                      {% csrf_token %}
                      <input type="hidden" name="explanation" value="{{ ai_explanation }}">
                      <button type="submit" class="btn btn-sm btn-outline-success">
                        âœ… å›ç­”ä¸éŒ¯ï¼Œå­˜å…¥è§£é‡‹
                      </button>
                      
                    </form>
<form id="followup-form" method="post" action="{% url 'ask_ai_followup' %}">
  {% csrf_token %}
  <input type="hidden" name="question_text" value="{{ question.question_text }}">
  <input type="hidden" name="ai_feedback" value="{{ ai_explanation }}">
  <input type="hidden" name="category" value="{{ category }}">
  <input type="hidden" name="options" value="{{ options }}">

  <div class="mb-3">
    <textarea name="followup" class="form-control" rows="3"
              placeholder="è¼¸å…¥ä½ æƒ³å•çš„å•é¡Œï¼Œä¾‹å¦‚ï¼šå¯ä»¥è§£é‡‹ elif æ˜¯ä»€éº¼å—ï¼Ÿ"></textarea>
  </div>
  <button type="submit" class="btn btn-primary">âœ‰ï¸ é€å‡ºè¿½å•</button>
</form>

<!-- å›è¦†çµæœæ”¾é€™è£¡ -->
<div id="followup-reply" class="mt-3"></div>
                  </div>
                {% endif %}

                {% if question.explanation %}
                  <div class="mt-4">
                    <strong>ğŸ“˜ åŸå…ˆè§£é‡‹ï¼š</strong><br>
                    {{ question.explanation|safe_markdown_ai|safe }}
                  </div>
                {% endif %}
              {% endif %}
            </div>

            <div class="modal-footer">
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="question_id" value="{{ question.id }}">
                <button type="submit" name="next" value="1" class="btn btn-success">ä¸‹ä¸€é¡Œ â¡ï¸</button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- é¡¯ç¤º Modal çš„ JS -->
      <script>
        document.addEventListener("DOMContentLoaded", function () {
          var resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
          resultModal.show();
        });
      </script>

      <!-- ğŸ“˜ åŸè§£é‡‹ï¼ˆç­”å°æˆ–ç­”éŒ¯éƒ½é¡¯ç¤ºï¼‰ -->
      {% if question.explanation %}
        <div class="alert alert-info mb-4 mt-3">
          ğŸ“˜ <strong>åŸè§£é‡‹ï¼š</strong><br>
          {{ question.explanation|safe_markdown_ai|safe }}
        </div>
      {% endif %}
    {% endif %}
  </div>
{% endif %}

<!-- é€²åº¦æ¢å‹•ç•« -->
<script>
  window.addEventListener("DOMContentLoaded", () => {
    const bar = document.querySelector(".progress-bar");
    if (bar) {
      const targetWidth = bar.getAttribute("data-width");
      setTimeout(() => {
        bar.style.width = `${targetWidth}%`;
      }, 100);
    }
  });
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const form = document.getElementById("followup-form");
  if (form) {
    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      const formData = new FormData(form);
      const responseDiv = document.getElementById("followup-reply");

      responseDiv.innerHTML = "âŒ› AI å›è¦†ä¸­...";

      try {
        const response = await fetch(form.action, {
          method: "POST",
          headers: {
            "X-CSRFToken": formData.get("csrfmiddlewaretoken"),
          },
          body: formData,
        });

        const data = await response.text(); // ä½ å›å‚³çš„æ˜¯ HTML partial
        responseDiv.innerHTML = data;
      } catch (err) {
        responseDiv.innerHTML = "âš ï¸ ç™¼é€å¤±æ•—ï¼š" + err;
      }
    });
  }
});
</script>

{% include 'quiz/_overlay_canvas.html' %}
{% include 'quiz/_search_mock_exam.html' %}

{% endblock %}
